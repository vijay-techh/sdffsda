<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Generate Bill</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root {
  --peacock: #016A70;
  --peacock-dark: #014d50;
  --accent: #02A2A8;
  --light-bg: #F5FEFF;
  --text: #023c7f;
  --card-bg: #ffffff;
  --border: #d9efef;
}

/* Page */
body {
  font-family: Inter, Arial, sans-serif;
  background: var(--light-bg);
  padding: 25px;
  margin: 0;
  color: var(--text);
}

/* Main Container */
.wrap {
  max-width: 1000px;
  margin: 0 auto;
  background: var(--card-bg);
  padding: 30px;
  border-radius: 18px;
  border: 1px solid rgba(1, 106, 112, 0.15);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  backdrop-filter: blur(3px);
}

/* Heading */
h2 {
  margin: 0 0 6px;
  color: var(--peacock-dark);
  font-size: 28px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.muted {
  font-size: 14px;
  color: #577c7e;
}

/* Top Row */
.top-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Back Button */
.back {
  background: var(--peacock);
  padding: 9px 18px;
  border-radius: 12px;
  color: #fff;
  text-decoration: none;
  font-size: 14px;
  font-weight: 600;
  transition: 0.22s ease-in-out;
  border: 1px solid transparent;
}

.back:hover {
  background: var(--peacock-dark);
  transform: translateY(-1px);
}

/* Label */
label {
  display: block;
  margin-top: 16px;
  font-weight: 600;
  color: var(--peacock-dark);
}

/* Inputs & Selects */
input, textarea, select {
  padding: 14px;
  width: 100%;
  margin-top: 6px;
  border: 1px solid #c5e2e2;
  border-radius: 10px;
  font-size: 15px;
  background: #ffffff;
  transition: all 0.25s ease;
}

input:focus, textarea:focus, select:focus {
  border-color: var(--peacock);
  box-shadow: 0 0 6px rgba(1, 106, 112, 0.35);
  outline: none;
}

/* Search Box */
.search-wrapper { margin-top: 10px; }

#searchResults {
  border: 1px solid #bfe9e9;
  border-radius: 10px;
  padding: 6px;
  background: white;
  max-height: 230px;
  overflow-y: auto;
  margin-top: 10px;
  display: none;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
}

.sr-item {
  padding: 12px;
  border-bottom: 1px solid #eef4f4;
  cursor: pointer;
  font-size: 15px;
  border-radius: 6px;
  transition: background 0.17s ease;
}

.sr-item:hover {
  background: #EAFDFC;
}

/* Product chips */
.products {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 12px;
}

.product-checkbox {
  padding: 11px 15px;
  border: 1px solid #bfe9e9;
  background: #fff;
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px;
  transition: 0.25s;
  color: var(--peacock-dark);
}

.product-checkbox:hover {
  background: var(--light-bg);
  border-color: var(--peacock);
  transform: translateY(-1px);
}

/* Item row container */
.item-row {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-top: 14px;
  background: #f7ffff;
  border: 1px solid #cfeeee;
  padding: 14px;
  border-radius: 12px;
  transition: 0.2s ease;
}

.item-row:hover {
  border-color: var(--accent);
  box-shadow: 0 4px 12px rgba(0,0,0,0.04);
}

.inline-row { display: flex; gap: 32px; }

/* Buttons */
.actions {
  margin-top: 24px;
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

button {
  padding: 13px 22px;
  background: var(--peacock);
  border-radius: 10px;
  color: white;
  font-size: 16px;
  cursor: pointer;
  font-weight: 600;
  border: none;
  transition: 0.25s;
}

button:hover {
  background: var(--peacock-dark);
  transform: translateY(-2px);
}

.secondary {
  background: #6e7c7e;
}

.secondary:hover {
  background: #556567;
}

/* Bill Preview */
#billPreview {
  margin-top: 28px;
  background: #F4FEFE;
  border: 1px solid #cceeee;
  border-radius: 14px;
  padding: 22px;
  display: none;
  box-shadow: 0 8px 22px rgba(0,0,0,0.07);
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 18px;
}

th {
  background: #e1f6f4;
  color: var(--peacock-dark);
  font-weight: 600;
  font-size: 15px;
}

th, td {
  border: 1px solid #d4ebea;
  padding: 12px;
  font-size: 15px;
  text-align: center;
}

/* Responsive */
@media (max-width: 720px) {
  .item-row { flex-direction: column; }
  .top-row { flex-direction: column; align-items: flex-start; gap: 12px;}
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top-row">
      <div><h2>Generate Bill</h2><div class="muted">Fetch existing customer or enter details manually</div></div>
      <div><a class="back" href="home.html">← Back</a></div>
    </div>

    <!-- Search (fixed spacing + proper input) -->
    <div class="search-wrapper">
      <label>Search Customer by name</label>
      <input id="searchName" type="text" placeholder="Type name (even one letter)..." autocomplete="off" />
      <div id="searchResults"></div>
    </div>

    <hr/>

    <!-- Customer fields -->
    <label>Customer Name *</label>
    <input id="name" placeholder="Customer name (or pick from search)" />

    <label>Phone *</label>
    <input id="phone" placeholder="Phone number" />

    <label>Additional Phone</label>
    <input id="alt_phone" placeholder="Optional" />

    <label>Address *</label>
    <textarea id="address" rows="2" placeholder="Address"></textarea>

    <label style="margin-top:14px">Products (select multiple)</label>
    <div id="productsList" class="products"></div>

    <div id="itemsContainer"></div>

    <div class="inline-row">
      <div>
        <label>Rent Start</label>
        <input type="date" id="rent_start" />
      </div>
      <div>
        <label>Rent End</label>
        <input type="date" id="rent_end" />
      </div>
    </div>

    <div class="actions">
      <button id="btnPreview">Generate Bill (Preview)</button>
      <button id="btnDownload">Download Bill</button>
      <button class="secondary" id="btnReset">Reset</button>
    </div>

    <div id="billPreview"></div>
  </div>

<script>
  // ---------- CONFIG ----------
  const PRODUCTS = ["xframe","alige","piller box","wheels","painting ladder","motor","supportings","machine"];
  const productsList = document.getElementById('productsList');
  const itemsContainer = document.getElementById('itemsContainer');
  const searchInput = document.getElementById('searchName');
  const searchResults = document.getElementById('searchResults');
  const previewBox = document.getElementById('billPreview');
  let savedPayload = null; // used by download button

  // populate product checkboxes
  PRODUCTS.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'product-checkbox';
    div.innerHTML = `<label style="margin:0;cursor:pointer"><input type="checkbox" id="chk_${p}" /> ${p}</label>`;
    productsList.appendChild(div);
    // click toggles checkbox and row
    div.addEventListener('click', (e)=>{
      if (e.target.tagName === 'INPUT') return; // checkbox handled
      const chk = document.getElementById(`chk_${p}`);
      chk.checked = !chk.checked;
      toggleProductRow(p, chk.checked);
    });
    // listen change on checkbox
    div.querySelector('input').addEventListener('change', (ev)=>{
      toggleProductRow(p, ev.target.checked);
    });
  });

  function toggleProductRow(prod, isChecked){
    if (isChecked) {
      if (document.getElementById(`row_${prod}`)) return;
      const row = document.createElement('div');
      row.className = 'item-row';
      row.id = `row_${prod}`;
      row.innerHTML = `
        <div style="flex:1"><strong>${prod}</strong></div>
        <input placeholder="Price" id="price_${prod}" type="number" min="0" step="0.01" />
        <input placeholder="Quantity" id="qty_${prod}" type="number" min="1" value="1" />
        <div><button type="button" onclick="removeProduct('${prod}')">Remove</button></div>
      `;
      itemsContainer.appendChild(row);
    } else {
      const r = document.getElementById(`row_${prod}`);
      if (r) r.remove();
      const chk = document.getElementById(`chk_${prod}`);
      if (chk) chk.checked = false;
    }
  }

  function removeProduct(prod){
    const chk = document.getElementById(`chk_${prod}`);
    if (chk) chk.checked = false;
    const r = document.getElementById(`row_${prod}`);
    if (r) r.remove();
  }

  // ---------- LIVE SEARCH ----------
  let searchTimer = null;
  searchInput.addEventListener('keyup', () => {
    clearTimeout(searchTimer);
    const q = searchInput.value.trim();
    if (!q) {
      searchResults.style.display = 'none';
      searchResults.innerHTML = '';
      return;
    }
    // small debounce
    searchTimer = setTimeout(async () => {
      try {
        const res = await fetch('/api/customers?q=' + encodeURIComponent(q));
        const data = await res.json();
        if (!data || !data.rows) {
          searchResults.style.display = 'none';
          return;
        }
        if (data.rows.length === 0) {
          searchResults.style.display = 'block';
          searchResults.innerHTML = '<div class="muted">No results</div>';
          return;
        }
        // render each row as .sr-item for spacing/hover
        searchResults.style.display = 'block';
        searchResults.innerHTML = data.rows.map(r => `<div class="sr-item" data-id="${r.id}">${escapeHtml(r.name)} — ${escapeHtml(r.phone)}</div>`).join('');
        // attach listeners
        searchResults.querySelectorAll('.sr-item').forEach(el=>{
          el.addEventListener('click', ()=> selectCustomer(el.getAttribute('data-id')));
        });
      } catch (err) {
        console.error(err);
      }
    }, 180);
  });

  // escape helper
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  // ---------- SELECT CUSTOMER ----------
  async function selectCustomer(id){
    try {
      const res = await fetch('/api/customer-details?id=' + encodeURIComponent(id));
      const data = await res.json();
      if (!data.success) { alert('Could not load customer'); return; }
      const c = data.customer;
      document.getElementById('name').value = c.name || '';
      document.getElementById('phone').value = c.phone || '';
      document.getElementById('alt_phone').value = c.alt_phone || '';
      document.getElementById('address').value = c.address || '';
      searchResults.style.display = 'none';
      // load most recent order items automatically if present
      if (data.orderDetails && data.orderDetails.length) {
        const last = data.orderDetails[0];
        // reset product rows
        PRODUCTS.forEach(p => {
          const chk = document.getElementById(`chk_${p}`);
          if (chk) chk.checked = false;
          const row = document.getElementById(`row_${p}`);
          if (row) row.remove();
        });
        // set rent dates if present
        if (last.order) {
          if (last.order.rent_start) document.getElementById('rent_start').value = last.order.rent_start.split('T')[0];
          if (last.order.rent_end) document.getElementById('rent_end').value = last.order.rent_end.split('T')[0];
        }
        // fill items
        (last.items || []).forEach(it => {
          const prod = it.product;
          const chk = document.getElementById(`chk_${prod}`);
          if (chk) chk.checked = true;
          toggleProductRow(prod, true);
          const priceEl = document.getElementById(`price_${prod}`);
          const qtyEl = document.getElementById(`qty_${prod}`);
          if (priceEl) priceEl.value = Number(it.price);
          if (qtyEl) qtyEl.value = Number(it.quantity);
        });
      }
    } catch (err) {
      console.error(err);
      alert('Error loading customer');
    }
  }

  // ---------- PREVIEW ----------
  document.getElementById('btnPreview').addEventListener('click', generatePreview);

  function collectItemsFromUI(){
    const items = [];
    for (const p of PRODUCTS){
      const chk = document.getElementById(`chk_${p}`);
      if (chk && chk.checked){
        const price = parseFloat(document.getElementById(`price_${p}`).value || 0);
        const qty = parseInt(document.getElementById(`qty_${p}`).value || 0, 10);
        if (!isFinite(price) || price <= 0 || !Number.isInteger(qty) || qty <= 0) {
          throw new Error(`Enter valid price & qty for ${p}`);
        }
        items.push({ product: p, price, quantity: qty });
      }
    }
    if (items.length === 0) throw new Error('Select at least one product');
    return items;
  }

  function computeDays(start, end){
    if (!start || !end) return 1;
    const s = new Date(start);
    const e = new Date(end);
    if (isNaN(s) || isNaN(e)) return 1;
    const diff = Math.floor((e - s) / (1000*60*60*24)) + 1;
    return Math.max(1, diff);
  }

  function generatePreview(){
    try {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const alt = document.getElementById('alt_phone').value.trim();
      if (!name || !phone || !address) { alert('Fill customer name, phone and address'); return; }

      const rent_start = document.getElementById('rent_start').value || null;
      const rent_end = document.getElementById('rent_end').value || null;
      const days = computeDays(rent_start, rent_end);

      const items = collectItemsFromUI();

      // compute totals
      let grand = 0;
      const rows = items.map(it=>{
        const amt = Number(it.price) * Number(it.quantity) * days;
        grand += amt;
        return { ...it, amount: amt };
      });

      // store payload for download (server expects items with price & quantity)
      savedPayload = {
        name, phone, alt_phone: alt, address, rent_start, rent_end,
        items: items.map(it => ({ product: it.product, price: it.price, quantity: it.quantity }))
      };

      // render preview
      let html = `<div style="display:flex;justify-content:space-between;align-items:center">
                    <div><h3 style="margin:0;text-decoration:underline;">SUBRAMANI ENTERPRISES</h3>
                    <div class="muted">Phone: 9916067960, 8073024022</div></div>
                    <div style="text-align:right"><small>${new Date().toLocaleDateString()}</small></div>
                  </div>
                  <hr/>
                  <div><strong>Name:</strong> ${escapeHtml(name)} &nbsp; <strong>Phone:</strong> ${escapeHtml(phone)}</div>
                  <div><strong>Address:</strong> ${escapeHtml(address)}</div>
                  <div style="margin-top:8px">
                  <strong>Rent:</strong> ${rent_start || 'N/A'} 
                  ${rent_end ? (' to ' + rent_end) : ''} 
                  &nbsp; <strong>(${days} day${days>1?'s':''})</strong>
                  </div>
                  <table>
                    <thead><tr><th>Description</th><th>Price</th><th>Qty</th><th>Amount</th></tr></thead><tbody>`;

      rows.forEach(r=> {
        html += `<tr><td>${escapeHtml(r.product)}</td><td>${Number(r.price).toFixed(2)}</td><td>${r.quantity}</td><td>₹ ${Number(r.amount).toFixed(2)}</td></tr>`;
      });

      html += `<tr><td colspan="3" style="text-align:right"><strong>Total</strong></td><td><strong>₹ ${Number(grand).toFixed(2)}</strong></td></tr>`;
      html += `</tbody></table>`;

      previewBox.innerHTML = html;
      previewBox.style.display = 'block';
      previewBox.scrollIntoView({behavior:'smooth'});
    } catch (err) {
      alert(err.message || 'Error building preview');
    }
  }

  // ---------- DOWNLOAD (call backend) ----------
  document.getElementById('btnDownload').addEventListener('click', async ()=>{
    if (!savedPayload) {
      // try to auto-generate payload from UI
      try {
        generatePreview(); // will set savedPayload
      } catch (e) {
        alert('Generate preview first or fix the input');
        return;
      }
    }
    // final check
    if (!savedPayload) { alert('No bill data to send'); return; }

    try {
      const res = await fetch('/api/generate-bill', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(savedPayload)
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.error || 'Error generating bill');
        return;
      }
      // open invoice PDF
      window.open(`/api/invoice/${data.orderId}`, '_blank');
    } catch (err) {
      console.error(err);
      alert('Server error while generating bill');
    }
  });

  // ---------- RESET ----------
  document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('name').value='';
    document.getElementById('phone').value='';
    document.getElementById('alt_phone').value='';
    document.getElementById('address').value='';
    document.getElementById('rent_start').value='';
    document.getElementById('rent_end').value='';
    searchInput.value = '';
    searchResults.style.display = 'none';
    previewBox.style.display = 'none';
    savedPayload = null;
    // remove rows & uncheck products
    PRODUCTS.forEach(p=>{
      const chk = document.getElementById(`chk_${p}`);
      if (chk) chk.checked = false;
      const r = document.getElementById(`row_${p}`);
      if (r) r.remove();
    });
  });

  // ---------- helpful: press Enter in search to select first result ----------
  searchInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      const first = searchResults.querySelector('.sr-item[data-id]');
      if (first) selectCustomer(first.getAttribute('data-id'));
    }
  });

  // ---------- init ----------
  (function init(){ /* nothing to do for now */ })();

</script>
</body>
</html>